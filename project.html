<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Proyecto • Detalle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles/global.css">
  <script defer src="./scripts/i18n.js"></script>
  <script>
    // Protección de acceso
    (function() {
      const AUTH_KEY = 'portfolio_authenticated';
      const AUTH_TIMESTAMP = 'portfolio_auth_timestamp';
      const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 horas
      
      function isAuthenticated() {
        const auth = sessionStorage.getItem(AUTH_KEY);
        const timestamp = sessionStorage.getItem(AUTH_TIMESTAMP);
        
        if (!auth || !timestamp) return false;
        
        const now = Date.now();
        const authTime = parseInt(timestamp, 10);
        
        if (now - authTime > SESSION_DURATION) {
          sessionStorage.removeItem(AUTH_KEY);
          sessionStorage.removeItem(AUTH_TIMESTAMP);
          return false;
        }
        
        return auth === 'true';
      }
      
      if (!isAuthenticated()) {
        window.location.href = './password.html';
      }
    })();
  </script>
  <style>
    /* Contenedor principal */
    body[data-page="project"] { background: var(--bg,#fff); color: var(--text,#0e0f12); padding-top: 56px; }
    main.project { max-width: 1100px; margin: 0 auto; padding: 24px 16px 80px; }

    .proj-hero { position: relative; border-radius: 20px; overflow: hidden; background: #f4f6f8; }
    .proj-hero img, .proj-hero video { display:block; width:100%; height:auto; object-fit: cover; }
    .proj-hero video { cursor: pointer; }
    .proj-meta { display:flex; gap:16px; align-items:center; justify-content: space-between; margin: 18px 0 8px; color: var(--muted,#6b7280); font-size: 14px; }
    .proj-meta-info { display:flex; gap:16px; align-items:center; }
    
    .back-arrow { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      color: var(--muted,#6b7280); 
      text-decoration: none; 
      font-size: 14px; 
      font-weight: 500;
      transition: all 0.2s ease;
      padding: 8px 12px;
      border-radius: 8px;
      margin-right: 16px;
    }
    .back-arrow:hover { 
      color: var(--text,#0e0f12); 
      background: rgba(0,0,0,0.04);
      transform: translateX(-2px);
    }
    .back-arrow svg { 
      width: 16px; 
      height: 16px; 
      transition: transform 0.2s ease;
    }
    .back-arrow:hover svg { 
      transform: translateX(-2px);
    }
    .dot { width:4px; height:4px; border-radius:999px; background: currentColor; opacity:.6; }

    .proj-title { font-size: clamp(28px, 4vw, 44px); line-height: 1.15; letter-spacing: -0.01em; margin: 6px 0 10px; }
    .proj-excerpt { font-size: 16px; color: var(--muted,#6b7280); padding-bottom: 40px; }

    .proj-tools { display:flex; flex-wrap:wrap; gap:8px; margin: 16px 0 24px; }
    .chip { padding:6px 10px; border-radius: 999px; background: rgba(0,0,0,0.06); color:#555; font-size: 12px; }
    [data-theme="dark"] .chip { background: rgba(255,255,255,0.08); color:#dfe3ea; }

    .proj-body { display:grid; gap:14px; margin-top: 20px; font-size: 16px; line-height: 1.8; }
    
    .proj-description { margin: 32px 0; }
    .proj-description h3 { font-size: 20px; font-weight: 600; margin: 24px 0 12px; color: var(--text,#0e0f12); }
    .proj-description p { font-size: 16px; line-height: 1.7; margin-bottom: 16px; color: var(--muted,#6b7280); }
    .proj-gallery { 
      display: grid; 
      gap: 20px; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      margin-top: 32px; 
    }
    .proj-gallery img { 
      width: 100%; 
      height: auto;
      min-height: 180px;
      max-height: 300px;
      object-fit: cover; 
      border-radius: 12px; 
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .proj-gallery img:hover { 
      transform: scale(1.02); 
      box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
    }
    .proj-gallery h4 { grid-column: 1 / -1; font-size: 16px; font-weight: 500; margin: 0 0 16px 0; color: var(--muted,#6b7280); text-transform: uppercase; letter-spacing: 0.5px; }
    .proj-gallery-card { 
      display: block; 
      text-decoration: none; 
      color: inherit; 
      background: var(--card,#fff); 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      transition: all 0.2s ease;
    }
    .proj-gallery-card:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
    }
    .proj-gallery-card img { width: 100%; height: 160px; object-fit: cover; }
    .proj-gallery-card-content { padding: 16px; }
    .proj-gallery-card h5 { font-size: 16px; font-weight: 600; margin: 0 0 8px 0; color: var(--text,#0e0f12); }
    .proj-gallery-card p { font-size: 14px; color: var(--muted,#6b7280); margin: 0; line-height: 1.4; }

    .proj-cta { margin-top: 24px; display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius: 12px; 
      background: rgba(0,0,0,0.06); color:#111; text-decoration:none; font-weight:700; border:1px solid rgba(0,0,0,0.12); }
    .proj-cta:hover { transform: translateY(-1px); }
    [data-theme="dark"] .proj-cta { background: rgba(255,255,255,0.08); color:#f3f4f6; border-color: rgba(255,255,255,0.18); }

    /* Link de toda la card en work.html (no rompe DOM) */
    .work-card__link { position:absolute; inset:0; z-index: 5; }

    /* Menu overlay: ajustes tipográficos y sociales (alineado con otras páginas) */
    body[data-page="project"] .menu-overlay .menu-links a{
      text-transform: none !important;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    body[data-page="project"] .menu-panel .menu-divider{ height:1px; background: var(--stroke); margin: 12px 0; }
    body[data-page="project"] .menu-panel .menu-social{ display:flex; gap:12px; padding-top:4px; }
    body[data-page="project"] .menu-panel .menu-social a{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:10px; border:1px solid var(--stroke);
      background: var(--fill-soft); color: var(--text);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    body[data-page="project"] .menu-panel .menu-social a:hover{ transform: translateY(-1px); background: var(--fill-soft); border-color: var(--stroke); }
    body[data-page="project"] .menu-panel .menu-social svg{ width:18px; height:18px; }
    body[data-page="project"] .menu-panel .menu-social .menu-lang{
      margin-left:auto;
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:36px; border-radius:10px; border:1px solid var(--stroke);
      background: var(--fill-soft); color: var(--text); font-weight:700; letter-spacing:.02em;
      cursor:pointer; transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    body[data-page="project"] .menu-panel .menu-social .menu-lang:hover{ transform: translateY(-1px); background: var(--fill-soft); border-color: var(--stroke); }
  </style>
</head>
<body data-page="project">
  <!-- NAV igual que en tus páginas -->
  <nav class="site-nav">
    <div class="nav-inner">
      <div class="menu-bar">
        <a class="menu-logo" href="./index.html">
          <img src="assets/cursors/JS_GRIS.svg" alt="JS" />
          <span class="logo-mask" aria-hidden="true"></span>
        </a>
        <button class="menu-toggle" id="menuToggle" aria-label="Open menu">
          <input type="checkbox" aria-hidden="true" tabindex="-1" />
          <div class="bars"><span></span><span></span></div>
        </button>
      </div>
      <div class="right-links"></div>
    </div>
  </nav>

  <div class="menu-overlay" id="menuOverlay" aria-hidden="true">
    <div class="menu-panel" id="menuPanel">
      <nav class="menu-links" aria-label="Primary">
        <a href="./work.html" data-i18n="menu.work">Work</a>
        <a href="./about.html" data-i18n="menu.about">About</a>
        <a href="./ai-corner.html" data-i18n="menu.ai">AI Lab</a>
      </nav>
      <div class="menu-divider" role="separator" aria-hidden="true"></div>
      <div class="menu-social" aria-label="Social links">
        <a href="https://www.instagram.com/jon_sagarminaga/" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5A5.5 5.5 0 1 1 6.5 13 5.5 5.5 0 0 1 12 7.5zm0 2A3.5 3.5 0 1 0 15.5 13 3.5 3.5 0 0 0 12 9.5zM17.8 6.2a1 1 0 1 1-1.6 1.2 1 1 0 0 1 1.6-1.2z"/>
          </svg>
        </a>
        <a href="https://www.linkedin.com/in/jon-sagarminaga-erkoreka/" target="_blank" rel="noopener" aria-label="LinkedIn" title="LinkedIn">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM.5 8h4V23h-4V8zm7 0h3.8v2.05h.05c.53-1 1.83-2.05 3.77-2.05 4.03 0 4.78 2.65 4.78 6.1V23h-4v-7.3c0-1.74-.03-3.98-2.43-3.98-2.44 0-2.82 1.9-2.82 3.86V23h-4V8z"/>
          </svg>
        </a>
        <button type="button" id="langToggle" class="menu-lang" aria-label="Toggle language" title="Language toggle">EN</button>
      </div>
    </div>
  </div>

  <main class="project" id="projectRoot" aria-busy="true">
    <!-- Se rellena por JS -->
  </main>

  <script src="./scripts/menu.js"></script>
  <script type="module">
    // --- utils
    const qs = (k) => new URLSearchParams(location.search).get(k);
    const root = document.getElementById('projectRoot');

    async function load() {
      const id = qs('id');
      if (!id) return notFound();

      // si pones en /data/projects.json cambia la ruta aquí
      const res = await fetch('./projects.json', { cache: 'no-store' });
      if (!res.ok) return notFound();
      const list = await res.json();
      const proj = list.find(p => p.slug === id);
      if (!proj) return notFound();

      document.title = `${proj.title} • Proyecto`;
      render(proj, list);
    }

    // Helper to get translation
    function t(key) {
      const lang = localStorage.getItem('site_lang') || 'es';
      const translations = {
        es: {
          'project.back': 'Atrás',
          'project.gallery': 'Galería del proyecto',
          'project.other': 'Ver otros proyectos',
          'project.view': 'Ver proyecto',
          'project.notFound': 'Proyecto no encontrado',
          'project.notFoundBack': 'Vuelve a',
        },
        en: {
          'project.back': 'Back',
          'project.gallery': 'Project Gallery',
          'project.other': 'View other projects',
          'project.view': 'View project',
          'project.notFound': 'Project not found',
          'project.notFoundBack': 'Go back to',
        },
      };
      return (translations[lang] && translations[lang][key]) || key;
    }

    function notFound() {
      root.innerHTML = `
        <h1>${t('project.notFound')}</h1>
        <p>${t('project.notFoundBack')} <a href="work.html" data-i18n="menu.work">Work</a>.</p>
      `;
      root.setAttribute('aria-busy', 'false');
      // Apply translations after DOM update
      setTimeout(() => {
        if (window.applyTranslations) window.applyTranslations();
      }, 100);
    }

    function render(p, allProjects) {
      // Get translated fields using i18n helper
      const getF = window.i18nGetField || ((obj, field) => obj[field]);
      const title = getF(p, 'title');
      const desc = getF(p, 'desc');
      const category = getF(p, 'category');
      
      const hero = p.hero?.type === 'video'
        ? `<video class="media" autoplay muted playsinline loop>
             <source src="${p.hero.src}" type="video/mp4">
           </video>`
        : `<img class="media" src="${p.image || ''}" alt="${title}">`;

      const tools = (p.tags || []).map(t => `<span class="chip">${t}</span>`).join('');
      const body  = (p.body  || []).map(par => `<p>${par}</p>`).join('');
      
      // Create project cards for other projects (excluding current one)
      const otherProjects = allProjects.filter(project => project.slug !== p.slug).slice(0, 3);
      const gal = otherProjects.map(project => {
        const pTitle = getF(project, 'title');
        const pDesc = getF(project, 'desc');
        return `
          <a href="project.html?id=${project.slug}" class="proj-gallery-card">
            <img src="${project.image}" alt="${pTitle}">
            <div class="proj-gallery-card-content">
              <h5>${pTitle}</h5>
              <p>${pDesc}</p>
            </div>
          </a>
        `;
      }).join('');
      
      // Description section with translation support
      const description = p.description ? `
        <section class="proj-description">
          <p>${getF(p.description, 'overview')}</p>
          ${(p.description.sections || []).map(section => `
            <h3>${getF(section, 'title')}</h3>
            <p>${getF(section, 'content')}</p>
          `).join('')}
        </section>
      ` : '';

      root.innerHTML = `
        <article>
          <header>
            <div class="proj-meta">
              <div class="proj-meta-info">
                <span>${p.year || ''}</span>
                <span class="dot"></span>
                <span>${category}</span>
              </div>
              <a href="work.html" class="back-arrow" aria-label="Volver a Work">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                <span data-i18n="project.back">Atrás</span>
              </a>
            </div>
            <h1 class="proj-title">${title}</h1>
            <p class="proj-excerpt">${desc}</p>
          </header>

          <section class="proj-hero" aria-label="Hero">
            ${hero}
          </section>

          <section class="proj-tools" aria-label="Herramientas">
            ${tools}
          </section>

          ${description}

          <section class="proj-body">
            ${body}
          </section>

          ${p.gallery?.length > 0 ? `<section class="proj-gallery" aria-label="Galería del proyecto">
            <h4 data-i18n="project.gallery">Galería del proyecto</h4>
            ${(p.gallery || []).map(src => `<img src="${src}" alt="Imagen del proyecto">`).join('')}
          </section>` : ''}
          
          ${otherProjects.length > 0 ? `<section class="proj-gallery" aria-label="Otros proyectos">
            <h4 data-i18n="project.other">Ver otros proyectos</h4>
            ${gal}
          </section>` : ''}

          ${p.links?.live ? `<a class="proj-cta" href="${p.links.live}" target="_blank" rel="noopener">
              <span data-i18n="project.view">Ver proyecto</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M14 5h5v5h-2V8.41l-8.29 8.3-1.42-1.42 8.3-8.29H14V5z"/>
              </svg>
            </a>` : ''}
        </article>
      `;
      root.setAttribute('aria-busy', 'false');
      
      // Apply translations after DOM update
      setTimeout(() => {
        if (window.applyTranslations) window.applyTranslations();
      }, 100);
      
      // Add click-to-pause functionality for videos
      const video = root.querySelector('video');
      if (video) {
        video.addEventListener('click', () => {
          if (video.paused) {
            video.play();
          } else {
            video.pause();
          }
        });
      }
      
      // Add lightbox functionality for gallery images
      const galleryImages = root.querySelectorAll('.proj-gallery img');
      galleryImages.forEach(img => {
        img.addEventListener('click', () => {
          // Create lightbox modal
          const lightbox = document.createElement('div');
          lightbox.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: pointer;
          `;
          
          const lightboxImg = document.createElement('img');
          lightboxImg.src = img.src;
          lightboxImg.style.cssText = `
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
          `;
          
          lightbox.appendChild(lightboxImg);
          document.body.appendChild(lightbox);
          
          // Close on click
          lightbox.addEventListener('click', () => {
            document.body.removeChild(lightbox);
          });
          
          // Close on escape key
          const handleEscape = (e) => {
            if (e.key === 'Escape') {
              document.body.removeChild(lightbox);
              document.removeEventListener('keydown', handleEscape);
            }
          };
          document.addEventListener('keydown', handleEscape);
        });
      });
    }

    // inicia
    load().catch(notFound);
  </script>
</body>
</html>
