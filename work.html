<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Work</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./styles/global.css">
  <script defer src="./scripts/i18n.js"></script>
  <script>
    // Protección de acceso
    (function() {
      const AUTH_KEY = 'portfolio_authenticated';
      const AUTH_TIMESTAMP = 'portfolio_auth_timestamp';
      const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 horas
      
      function isAuthenticated() {
        const auth = sessionStorage.getItem(AUTH_KEY);
        const timestamp = sessionStorage.getItem(AUTH_TIMESTAMP);
        
        if (!auth || !timestamp) return false;
        
        const now = Date.now();
        const authTime = parseInt(timestamp, 10);
        
        if (now - authTime > SESSION_DURATION) {
          sessionStorage.removeItem(AUTH_KEY);
          sessionStorage.removeItem(AUTH_TIMESTAMP);
          return false;
        }
        
        return auth === 'true';
      }
      
      if (!isAuthenticated()) {
        window.location.href = './password.html';
      }
    })();
  </script>
  <script defer src="./scripts/menu.js"></script>
  <style>
    /* Menu overlay: ajustes tipográficos y sociales (alineado con AI Corner) */
    body[data-page="work"] .menu-overlay .menu-links a{
      text-transform: none !important;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    body[data-page="work"] .menu-panel .menu-divider{ height:1px; background: var(--stroke); margin: 12px 0; }
    body[data-page="work"] .menu-panel .menu-social{ display:flex; gap:12px; padding-top:4px; }
    body[data-page="work"] .menu-panel .menu-social a{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:10px; border:1px solid var(--stroke);
      background: var(--fill-soft); color: var(--text);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    body[data-page="work"] .menu-panel .menu-social a:hover{ transform: translateY(-1px); background: var(--fill-soft); border-color: var(--stroke); }
    body[data-page="work"] .menu-panel .menu-social svg{ width:18px; height:18px; }
    body[data-page="work"] .menu-panel .menu-social .menu-lang{
      margin-left: auto;
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:36px; border-radius:10px; border:1px solid var(--stroke);
      background: var(--fill-soft); color: var(--text); font-weight:700; letter-spacing:.02em;
      cursor:pointer; transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    body[data-page="work"] .menu-panel .menu-social .menu-lang:hover{ transform: translateY(-1px); background: var(--fill-soft); border-color: var(--stroke); }
  </style>
</head>
<body class="bg-white text-gray-900" data-page="work">
  <nav class="site-nav">
    <div class="nav-inner">
      <div class="menu-bar">
        <a class="menu-logo" href="./index.html"><img src="assets/cursors/JS_GRIS.svg" alt="JS" /><span class="logo-mask" aria-hidden="true"></span></a>
        <button id="menuToggle" class="menu-toggle" aria-label="Open menu">
          <input type="checkbox" aria-hidden="true" tabindex="-1" />
          <div class="bars"><span></span><span></span></div>
        </button>
      </div>
      <div class="right-links"></div>
    </div>
  </nav>

  <div id="menuOverlay" class="menu-overlay" aria-hidden="true">
    <div id="menuPanel" class="menu-panel">
      <nav class="menu-links" aria-label="Primary">
        <a href="./work.html" data-i18n="menu.work">Work</a>
        <a href="./about.html" data-i18n="menu.about">About</a>
        <a href="./ai-corner.html" data-i18n="menu.ai">AI Lab</a>
      </nav>
      <div class="menu-divider" role="separator" aria-hidden="true"></div>
      <div class="menu-social" aria-label="Social links">
        <a href="https://www.instagram.com/jon_sagarminaga/" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5A5.5 5.5 0 1 1 6.5 13 5.5 5.5 0 0 1 12 7.5zm0 2A3.5 3.5 0 1 0 15.5 13 3.5 3.5 0 0 0 12 9.5zM17.8 6.2a1 1 0 1 1-1.6 1.2 1 1 0 0 1 1.6-1.2z"/>
          </svg>
        </a>
        <a href="https://www.linkedin.com/in/jon-sagarminaga-erkoreka/" target="_blank" rel="noopener" aria-label="LinkedIn" title="LinkedIn">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM.5 8h4V23h-4V8zm7 0h3.8v2.05h.05c.53-1 1.83-2.05 3.77-2.05 4.03 0 4.78 2.65 4.78 6.1V23h-4v-7.3c0-1.74-.03-3.98-2.43-3.98-2.44 0-2.82 1.9-2.82 3.86V23h-4V8z"/>
          </svg>
        </a>
        <button type="button" id="langToggle" class="menu-lang" aria-label="Toggle language" title="Language toggle">EN</button>
      </div>
    </div>
  </div>

  

  <main>
    <section class="relative min-h-[calc(100dvh-56px)] overflow-x-hidden overflow-y-visible pt-8 pb-8">
      <div id="gallery" class="absolute inset-0 flex items-center select-none py-4 overflow-visible" style="touch-action: none; -webkit-user-select: none; user-select: none; cursor: grab;">
        <div id="track" class="gallery-track flex gap-8 px-8"></div>
      </div>
    </section>
  </main>

  <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl w-[90vw] overflow-hidden">
      <div class="flex items-center justify-between border-b px-4 py-3">
        <h2 id="modalTitle" class="font-semibold"></h2>
        <button id="closeModal" class="p-2 hover:bg-black/10 rounded-full cursor-pointer" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="p-4 grid md:grid-cols-2 gap-4">
        <img id="modalImage" class="w-full h-64 object-cover rounded-lg" src="" alt="" />
        <div>
          <p id="modalDesc" class="text-sm text-gray-700"></p>
          <div id="modalTags" class="mt-3 flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let works = [];

    function gradientFor(id){
      const gradients = [
        'from-purple-500/30 via-pink-500/20 to-transparent',
        'from-blue-500/30 via-cyan-500/20 to-transparent',
        'from-orange-500/30 via-red-500/20 to-transparent',
        'from-green-500/30 via-emerald-500/20 to-transparent',
        'from-indigo-500/30 via-purple-500/20 to-transparent',
        'from-teal-500/30 via-green-500/20 to-transparent',
      ];
      let hash = 0; for (let i=0;i<id.length;i++){ hash = (hash*31 + id.charCodeAt(i)) >>> 0; }
      return gradients[hash % gradients.length];
    }

    const track = document.getElementById('track');
    
    // Sistema de gradient aleatorio (igual que menu.js)
    function randomGradient(){ 
      const h = Math.floor(Math.random()*360); 
      const h2 = (h+60)%360; 
      return `linear-gradient(135deg, hsl(${h} 80% 65%), hsl(${h2} 80% 65%))`; 
    }
    
    // Cargar proyectos desde JSON
    async function loadWorks(){
      try {
        const res = await fetch('./projects.json', { cache: 'no-cache' });
        works = await res.json();
        const tripled = [...works, ...works, ...works];
        render(tripled);
      } catch (error) {
        console.error('Error loading projects:', error);
        const lang = localStorage.getItem('site_lang') || 'es';
        const errorMsg = lang === 'en' ? 'Error loading projects' : 'Error al cargar proyectos';
        track.innerHTML = `<p data-i18n="work.error">${errorMsg}</p>`;
        // Apply translations after DOM update
        setTimeout(() => {
          if (window.applyTranslations) window.applyTranslations();
        }, 100);
      }
    }
    
    function render(tripled){
      track.innerHTML = '';
      tripled.forEach(w => {
        // Get translated fields using i18n helper
        const getF = window.i18nGetField || ((obj, field) => obj[field]);
        const title = getF(w, 'title');
        const desc = getF(w, 'desc');
        const category = getF(w, 'category');
        
        const card = document.createElement('div');
        card.className = 'work-card group relative w-[420px] h-[calc(100vh-56px-32px)] rounded-2xl overflow-hidden shrink-0 bg-white transition-transform duration-300 ease-out hover:scale-[1.02] hover:shadow-lg mb-6 cursor-pointer';
        card.innerHTML = `
          <div class="absolute inset-x-0 top-0 h-[60%] overflow-hidden media-clip">
            ${
              (w.image && w.image.endsWith('.mp4'))
                ? `<video class="w-full h-full object-cover block" autoplay muted playsinline loop>
                     <source src="${w.image}" type="video/mp4">
                   </video>`
                : (w.hero?.type === 'video'
                    ? `<video class="w-full h-full object-cover block" autoplay muted playsinline loop>
                         <source src="${w.hero.src}" type="video/mp4">
                       </video>`
                    : `<img src="${w.hero?.src || w.image}" alt="${title}" class="w-full h-full object-cover block" />`
                  )
            }
            <div class="absolute inset-0 bg-gradient-to-t ${gradientFor(w.id)} opacity-30 group-hover:opacity-60 transition-opacity duration-300 pointer-events-none"></div>
          </div>
          <div class="absolute inset-x-0 bottom-0 h-[40%] flex flex-col justify-between p-6">
            <div>
              <div class="flex items-center justify-between text-xs tracking-wide text-gray-600">
                <span>${w.year}</span>
                <span>${category}</span>
              </div>
              <h3 class="mt-2 text-xl font-semibold text-gray-900">${title}</h3>
              <p class="mt-2 text-sm leading-6 text-gray-600 line-clamp-3">${desc}</p>
            </div>
            <div class="mt-3 flex flex-wrap gap-2 pb-2">
              ${(()=>{ const max=3; const chips=w.tags.slice(0,max).map(t=>`<span class=\"text-xs px-2 py-1 rounded-full bg-gray-100\">${t}</span>`).join(''); const rest=w.tags.length-max; return rest>0? chips+`<span class=\"text-xs px-2 py-1 rounded-full bg-gray-100\">+${rest}</span>`:chips; })()}
            </div>
          </div>
          <!-- Overlay de gradient aleatorio en hover -->
          <div class="absolute inset-0 bg-gradient-to-t opacity-0 group-hover:opacity-40 transition-opacity duration-300 pointer-events-none rounded-inherit hover-gradient"></div>
          <!-- Link invisible que cubre toda la card -->
          <a class="work-card__link" href="project.html?id=${w.slug}" aria-label="Ver detalle: ${title}"></a>`;
        
        // Event listeners para gradient aleatorio en hover
        const hoverGradient = card.querySelector('.hover-gradient');
        card.addEventListener('mouseenter', () => {
          hoverGradient.style.background = randomGradient();
        });
        card.addEventListener('mouseleave', () => {
          hoverGradient.style.background = '';
        });
        
        track.appendChild(card);
      });
    }
    loadWorks();

    let x = 0; // current translateX
    let animId = 0;
    let paused = false;
    let speed = 80; // px per second (slower)
    let targetX = 0;

    function normalize(value, width){
      if (width <= 0) return value;
      let v = ((value % width) + width) % width; // [0,width)
      return v - width; // keep in [-width,0)
    }

    function loop(ts){
      if (!loop.last) loop.last = ts;
      const dt = (ts - loop.last) / 1000;
      loop.last = ts;
      if (!paused) {
        targetX -= speed * dt;
      }
      const setWidth = track.scrollWidth / 3;
      x += (targetX - x) * 0.12; // ease toward target
      const vis = normalize(x, setWidth);
      track.style.transform = `translateX(${vis}px)`;
      animId = requestAnimationFrame(loop);
    }
    // Start centered on the middle copy to allow immediate left/right scrolling
    const startCentered = () => {
      const setWidth = track.scrollWidth / 3;
      if (setWidth > 0) {
        x = -setWidth;
        targetX = -setWidth;
        track.style.transform = `translateX(${-setWidth}px)`;
      }
      animId = requestAnimationFrame(loop);
    };
    // Delay to ensure layout is measured
    requestAnimationFrame(startCentered);

    // Hover pause
    const gallery = document.getElementById('gallery');
    gallery.addEventListener('mouseenter', () => { paused = true; });
    gallery.addEventListener('mouseleave', () => { paused = false; });

    // Drag control con eventos táctiles nativos
    let dragging = false;
    let startX = 0;
    let startTx = 0;
    let moved = 0;
    let dragStartedOnLink = false;

    // Touch events para móvil
    gallery.addEventListener('touchstart', (e) => {
      dragStartedOnLink = false;
      dragging = true;
      startX = e.touches[0].clientX;
      startTx = targetX;
      moved = 0;
      paused = true;
      
      // Deshabilitar pointer-events de los links mientras se arrastra
      const cards = gallery.querySelectorAll('.work-card');
      cards.forEach(card => {
        const link = card.querySelector('.work-card__link');
        if (link) link.style.pointerEvents = 'none';
      });
    }, { passive: true });

    gallery.addEventListener('touchmove', (e) => {
      if (!dragging) return;
      const dx = e.touches[0].clientX - startX;
      moved = Math.max(moved, Math.abs(dx));
      targetX = startTx + dx;
    }, { passive: true });

    gallery.addEventListener('touchend', (e) => {
      dragging = false;
      paused = false;
      
      // Re-habilitar pointer-events de los links
      const cards = gallery.querySelectorAll('.work-card');
      cards.forEach(card => {
        const link = card.querySelector('.work-card__link');
        if (link) link.style.pointerEvents = 'auto';
      });
      
      // Si el movimiento fue mínimo (<10px), permitir que funcione como click
      if (moved < 10) {
        const target = e.target.closest('.work-card');
        if (target) {
          const link = target.querySelector('.work-card__link');
          if (link) {
            setTimeout(() => link.click(), 50);
          }
        }
      }
    });

    // Mouse events para desktop
    gallery.addEventListener('mousedown', (e) => {
      if (e.target.closest('a')) {
        dragStartedOnLink = true;
        dragging = false;
        return;
      }
      dragStartedOnLink = false;
      dragging = true;
      startX = e.clientX;
      startTx = targetX;
      moved = 0;
      paused = true;
      gallery.style.cursor = 'grabbing';
    });

    gallery.addEventListener('mousemove', (e) => {
      if (!dragging || dragStartedOnLink) return;
      const dx = e.clientX - startX;
      moved = Math.max(moved, Math.abs(dx));
      targetX = startTx + dx;
    });

    gallery.addEventListener('mouseup', () => {
      dragging = false;
      paused = false;
      gallery.style.cursor = 'grab';
    });

    gallery.addEventListener('mouseleave', () => {
      if (dragging) {
        dragging = false;
        paused = false;
        gallery.style.cursor = 'grab';
      }
    });

    // No canceles clicks: deja que los <a> funcionen
    // (mantenemos este handler por si acaso, pero ya no prevenimos nada)
    gallery.addEventListener('click', (e) => {
      // si el usuario arrastró mucho Y el click fue en el fondo del gallery, podrías prevenir
      // pero como no usamos pointer capture, los <a> ya reciben su click normal
      // if (moved > 8 && e.target === gallery) e.preventDefault();
    });

    // Mouse wheel horizontal scroll
    gallery.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
      targetX -= delta; // wrapping handled in loop
    }, { passive: false });

    // Modal
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalImage = document.getElementById('modalImage');
    const modalDesc = document.getElementById('modalDesc');
    const modalTags = document.getElementById('modalTags');
    function openModal(w){
      modalTitle.textContent = w.title;
      modalImage.src = w.image;
      modalDesc.textContent = w.desc;
      modalTags.innerHTML = w.tags.map(t=>`<span class="text-xs px-2 py-1 rounded-full bg-gray-100">${t}</span>`).join('');
      modal.style.display = 'flex';
    }
    document.getElementById('closeModal').addEventListener('click', ()=>{ modal.style.display = 'none'; });
    modal.addEventListener('click', (e)=>{ if (e.target === modal) modal.style.display = 'none'; });

    
  </script>
</body>
</html>


