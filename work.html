<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Work</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./styles/global.css">
  <script defer src="./scripts/menu.js"></script>
</head>
<body class="bg-white text-gray-900" data-page="work">
  <nav class="site-nav">
    <div class="nav-inner">
      <div class="menu-bar">
        <a class="menu-logo" href="./index.html"><img src="assets/cursors/JS_GRIS.svg" alt="JS" /><span class="logo-mask" aria-hidden="true"></span></a>
        <button id="menuToggle" class="menu-toggle" aria-label="Open menu">
          <input type="checkbox" aria-hidden="true" tabindex="-1" />
          <div class="bars"><span></span><span></span></div>
        </button>
      </div>
      <div class="right-links"></div>
    </div>
  </nav>

  <div id="menuOverlay" class="menu-overlay" aria-hidden="true">
    <div id="menuPanel" class="menu-panel">
      <nav class="menu-links" aria-label="Primary">
        <a href="./work.html">Work</a>
        <a href="./about.html">About</a>
        <a href="./ai-corner.html">AI Lab</a>
      </nav>
    </div>
  </div>

  

  <main>
    <section class="relative min-h-[calc(100dvh-56px)] overflow-x-hidden overflow-y-visible pt-8 pb-8">
      <div id="gallery" class="absolute inset-0 flex items-center select-none py-4 overflow-visible">
        <div id="track" class="gallery-track flex gap-8 px-8"></div>
      </div>
    </section>
  </main>

  <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl w-[90vw] overflow-hidden">
      <div class="flex items-center justify-between border-b px-4 py-3">
        <h2 id="modalTitle" class="font-semibold"></h2>
        <button id="closeModal" class="p-2 hover:bg-black/10 rounded-full cursor-pointer" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="p-4 grid md:grid-cols-2 gap-4">
        <img id="modalImage" class="w-full h-64 object-cover rounded-lg" src="" alt="" />
        <div>
          <p id="modalDesc" class="text-sm text-gray-700"></p>
          <div id="modalTags" class="mt-3 flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let works = [];

    function gradientFor(id){
      const gradients = [
        'from-purple-500/30 via-pink-500/20 to-transparent',
        'from-blue-500/30 via-cyan-500/20 to-transparent',
        'from-orange-500/30 via-red-500/20 to-transparent',
        'from-green-500/30 via-emerald-500/20 to-transparent',
        'from-indigo-500/30 via-purple-500/20 to-transparent',
        'from-teal-500/30 via-green-500/20 to-transparent',
      ];
      let hash = 0; for (let i=0;i<id.length;i++){ hash = (hash*31 + id.charCodeAt(i)) >>> 0; }
      return gradients[hash % gradients.length];
    }

    const track = document.getElementById('track');
    
    // Sistema de gradient aleatorio (igual que menu.js)
    function randomGradient(){ 
      const h = Math.floor(Math.random()*360); 
      const h2 = (h+60)%360; 
      return `linear-gradient(135deg, hsl(${h} 80% 65%), hsl(${h2} 80% 65%))`; 
    }
    
    // Cargar proyectos desde JSON
    async function loadWorks(){
      try {
        const res = await fetch('./projects.json', { cache: 'no-cache' });
        works = await res.json();
        const tripled = [...works, ...works, ...works];
        render(tripled);
      } catch (error) {
        console.error('Error loading projects:', error);
        track.innerHTML = '<p>Error loading projects</p>';
      }
    }
    
    function render(tripled){
      track.innerHTML = '';
      tripled.forEach(w => {
        const card = document.createElement('div');
        card.className = 'work-card group relative w-[420px] h-[calc(100vh-56px-32px)] rounded-2xl overflow-hidden shrink-0 bg-white transition-transform duration-300 ease-out hover:scale-[1.02] hover:shadow-lg mb-6 cursor-pointer';
        card.innerHTML = `
          <div class="absolute inset-x-0 top-0 h-[60%] overflow-hidden media-clip">
            ${w.hero?.type === 'video' 
              ? `<video class="w-full h-full object-cover block" autoplay muted playsinline loop>
                   <source src="${w.hero.src}" type="video/mp4">
                 </video>`
              : `<img src="${w.hero?.src || w.image}" alt="${w.title}" class="w-full h-full object-cover block" />`
            }
            <div class="absolute inset-0 bg-gradient-to-t ${gradientFor(w.id)} opacity-30 group-hover:opacity-60 transition-opacity duration-300 pointer-events-none"></div>
          </div>
          <div class="absolute inset-x-0 bottom-0 h-[40%] flex flex-col justify-between p-6">
            <div>
              <div class="flex items-center justify-between text-xs tracking-wide text-gray-600">
                <span>${w.year}</span>
                <span>${w.category}</span>
              </div>
              <h3 class="mt-2 text-xl font-semibold text-gray-900">${w.title}</h3>
              <p class="mt-2 text-sm leading-6 text-gray-600 line-clamp-3">${w.desc}</p>
            </div>
            <div class="mt-3 flex flex-wrap gap-2 pb-2">
              ${(()=>{ const max=3; const chips=w.tags.slice(0,max).map(t=>`<span class=\"text-xs px-2 py-1 rounded-full bg-gray-100\">${t}</span>`).join(''); const rest=w.tags.length-max; return rest>0? chips+`<span class=\"text-xs px-2 py-1 rounded-full bg-gray-100\">+${rest}</span>`:chips; })()}
            </div>
          </div>
          <!-- Overlay de gradient aleatorio en hover -->
          <div class="absolute inset-0 bg-gradient-to-t opacity-0 group-hover:opacity-40 transition-opacity duration-300 pointer-events-none rounded-inherit hover-gradient"></div>
          <!-- Link invisible que cubre toda la card -->
          <a class="work-card__link" href="project.html?id=${w.slug}" aria-label="Ver detalle: ${w.title}"></a>`;
        
        // Event listeners para gradient aleatorio en hover
        const hoverGradient = card.querySelector('.hover-gradient');
        card.addEventListener('mouseenter', () => {
          hoverGradient.style.background = randomGradient();
        });
        card.addEventListener('mouseleave', () => {
          hoverGradient.style.background = '';
        });
        
        track.appendChild(card);
      });
    }
    loadWorks();

    let x = 0; // current translateX
    let animId = 0;
    let paused = false;
    let speed = 80; // px per second (slower)
    let targetX = 0;

    function normalize(value, width){
      if (width <= 0) return value;
      let v = ((value % width) + width) % width; // [0,width)
      return v - width; // keep in [-width,0)
    }

    function loop(ts){
      if (!loop.last) loop.last = ts;
      const dt = (ts - loop.last) / 1000;
      loop.last = ts;
      if (!paused) {
        targetX -= speed * dt;
      }
      const setWidth = track.scrollWidth / 3;
      x += (targetX - x) * 0.12; // ease toward target
      const vis = normalize(x, setWidth);
      track.style.transform = `translateX(${vis}px)`;
      animId = requestAnimationFrame(loop);
    }
    // Start centered on the middle copy to allow immediate left/right scrolling
    const startCentered = () => {
      const setWidth = track.scrollWidth / 3;
      if (setWidth > 0) {
        x = -setWidth;
        targetX = -setWidth;
        track.style.transform = `translateX(${-setWidth}px)`;
      }
      animId = requestAnimationFrame(loop);
    };
    // Delay to ensure layout is measured
    requestAnimationFrame(startCentered);

    // Hover pause
    const gallery = document.getElementById('gallery');
    gallery.addEventListener('mouseenter', () => { paused = true; });
    gallery.addEventListener('mouseleave', () => { paused = false; });

    // Drag control (sin romper los <a>)
    let dragging = false;
    let startX = 0;
    let startTx = 0;
    let moved = 0;
    let dragStartedOnLink = false;

    gallery.addEventListener('pointerdown', (e) => {
      // Si haces down encima de un link dentro de una card, no activamos drag
      if (e.target.closest('a')) {
        dragStartedOnLink = true;
        dragging = false;
        return;
      }
      dragStartedOnLink = false;
      dragging = true;
      startX = e.clientX;
      startTx = targetX;
      moved = 0;
      // IMPORTANTE: no usamos setPointerCapture aquí (anula el click de los enlaces)
      // gallery.setPointerCapture(e.pointerId); // <-- fuera
    });

    gallery.addEventListener('pointermove', (e) => {
      if (!dragging || dragStartedOnLink) return;
      paused = true;
      const dx = e.clientX - startX;
      moved = Math.max(moved, Math.abs(dx));
      targetX = startTx + dx;
    });

    gallery.addEventListener('pointerup', () => {
      dragging = false;
      paused = false;
    });

    // No canceles clicks: deja que los <a> funcionen
    // (mantenemos este handler por si acaso, pero ya no prevenimos nada)
    gallery.addEventListener('click', (e) => {
      // si el usuario arrastró mucho Y el click fue en el fondo del gallery, podrías prevenir
      // pero como no usamos pointer capture, los <a> ya reciben su click normal
      // if (moved > 8 && e.target === gallery) e.preventDefault();
    });

    // Mouse wheel horizontal scroll
    gallery.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
      targetX -= delta; // wrapping handled in loop
    }, { passive: false });

    // Modal
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalImage = document.getElementById('modalImage');
    const modalDesc = document.getElementById('modalDesc');
    const modalTags = document.getElementById('modalTags');
    function openModal(w){
      modalTitle.textContent = w.title;
      modalImage.src = w.image;
      modalDesc.textContent = w.desc;
      modalTags.innerHTML = w.tags.map(t=>`<span class="text-xs px-2 py-1 rounded-full bg-gray-100">${t}</span>`).join('');
      modal.style.display = 'flex';
    }
    document.getElementById('closeModal').addEventListener('click', ()=>{ modal.style.display = 'none'; });
    modal.addEventListener('click', (e)=>{ if (e.target === modal) modal.style.display = 'none'; });

    
  </script>
</body>
</html>


